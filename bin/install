#!/usr/bin/env ruby
require 'optparse'
require 'singleton'
require 'os'


class Installer
  include Singleton
  def mac?
    RUBY_PLATFORM.include?('-darwin')
  end
  def linux?
    RUBY_PLATFORM.include?('-linux-')
  end
  def has_brew?
    `which brew`.present?
  end

  def install_all
    install_submodules
    install_youcompleteme
    link_all
    pid = Kernel.spawn({}, 'git submodule update --init --recursive')
    Process.wait2(pid)
  end

  def link_all
    pid = Kernel.spawn({}, 'bin/link')
    Process.wait2(pid)
  end

  def install_submodules
    pid = Kernel.spawn({}, 'git submodule update --init --recursive')
    Process.wait2(pid)
  end

  def install_youcompleteme
    install_universal_ctags
    pid = Kernel.spawn({}, 'cd vim/pack/dist/start/YouCompleteMe ; install.sh')
    Process.wait2(pid)
  end

  def brew_dependant
    raise "must have homebrew installed" unless has_brew?
  end

  def install_universal_ctags
    if mac?
      brew_dependant
      pid = Kernel.spawn({}, 'brew install --HEAD universal-ctags/universal-ctags/universal-ctags')
      Process.wait2(pid)
    elsif linux?
      script = <<-BASH
        git clone https://github.com/universal-ctags/ctags.git
        cd ctags
        ./autogen.sh
        ./configure
        make
        sudo make install

      BASH
      pid = Kernel.spawn({}, script)
    end
  end

  def install_vim
    brew_dependant
    pid = Kernel.spawn({}, 'brew install vim')
    Process.wait2(pid)
  end

  def install_vimr
    brew_dependant

    pid = Kernel.spawn({}, 'brew cask install vimr')
    Process.wait2(pid)
  end
end

@options = {}
res = OptionParser.new do |opts|
  opts.on('--all') do |_|
    Installer.instance.install_all
  end
  # opts.on('--vim') do |_|
  #   Installer.instance.install_vim
  # end
  # opts.on('--vimr') do |_|
  #   Installer.instance.install_vimr
  # end
end.parse!
